{% extends 'base.html' %}
{% load static %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/product.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

{% endblock %}

{% block content %}
<div class="film-preview" style="background-image: url('{{ movie.preview_poster.url }}')">
    <div class="container">
        <div class="film-title">
            {{ movie.title }}
        </div>

        <div class="film-type">
            {{ movie.category }}
        </div>
    </div>
</div>

<div class="container">
    <div class="big-block">
        <div class="block-one">
            <div class="film-desc">
                {{ movie.description }}
            </div>

            <div class="watch-buttons">
                <div class="watch-trailer">
                    <button  onclick="openPopup('trailer-popup')">Смотреть Трейлер</button>
                </div>

                <div class="watch-film">
                    <button onclick="openPopup('film-popup')">Смотреть Фильм</button>
                </div>
            </div>

            <div class="film-info">
                <div class="country">
                    <span>Страна:</span> {{ movie.country }}
                </div>

                <div class="role">
                    <span>В ролях:</span>
                    {% for actor in movie.actors.all|slice:":2" %}
                        <a class="actor-name" href="{% url 'actor_detail' pk=actor.pk %}">{{ actor.name }}</a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                    {% if movie.actors.count > 2 %}
                        <a class="actor-name" href="{% url 'actor_list' slug=movie.url %}">{{ movie.actors.count }} актеров</a>
                    {% endif %}
                </div>



                <div class="director">
                    <span>Режиссер:</span>
                    {% for director in movie.directors.all %}
                    <a class="actor-name" href="{% url 'actor_detail' pk=director.pk %}">{{ director.name }}</a>{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>

            </div>


        </div>

<div class="popup-movie" id="trailer-popup">
    <div class="container-trailer show-controls">
        <div class="wrapper-trailer">
            <span class="close">&times;</span>
            <div class="video-timeline-trailer">
                <div class="progress-area-trailer">
                    <span>00:00</span>
                    <div class="progress-bar-trailer"></div>
                </div>
            </div>
            <ul class="video-controls-trailer">
                <li class="options-trailer left">
                    <button class="volume"><i class="fa-solid fa-volume-high"></i></button>
                    <input type="range" min="0" max="1" step="any">
                    <div class="video-timer-trailer">
                        <p class="current-time">00:00</p>
                        <p class="separator"> / </p>
                        <p class="video-duration">00:00</p>
                    </div>
                </li>
                <li class="options-trailer">
                    <button class="skip-backward"><i class="fas fa-backward"></i></button>
                    <button class="play-pause"><i class="fas fa-play"></i></button>
                    <button class="skip-forward"><i class="fas fa-forward"></i></button>
                </li>
                <li class="options-trailer right">
                    <div class="playback-content-trailer">
                        <button class="playback-speed"><span class="material-symbols-rounded">slow_motion_video</span></button>
                        <ul class="speed-options-trailer">
                            <li data-speed="2">2x</li>
                            <li data-speed="1.5">1.5x</li>
                            <li data-speed="1" class="active">Normal</li>
                            <li data-speed="0.75">0.75x</li>
                            <li data-speed="0.5">0.5x</li>
                        </ul>
                    </div>
                    <button class="pic-in-pic"><span class="material-icons">picture_in_picture_alt</span></button>
                    <button class="fullscreen"><i class="fa-solid fa-expand"></i></button>
                </li>
            </ul>
        </div>
        <video class="tr" id="main-video-tr"  src="{{ trailer_url }}" controls></video>
    </div>
</div>


<div class="popup-movie" id="film-popup">
    <div class="containerr show-controls">
        <div class="wrapper">
            <span class="close">&times;</span>
            <div class="video-timeline">
                <div class="progress-area">
                    <span>00:00</span>
                    <div class="progress-bar"></div>
                </div>
            </div>
            <ul class="video-controls">
                <li class="options left">
                    <button class="volume"><i class="fa-solid fa-volume-high"></i></button>
                    <input type="range" min="0" max="1" step="any">
                    <div class="video-timer">
                        <p class="current-time">00:00</p>
                        <p class="separator"> / </p>
                        <p class="video-duration">00:00</p>
                    </div>
                </li>
                <li class="options">
                    <button class="skip-backward"><i class="fas fa-backward"></i></button>
                    <button class="play-pause"><i class="fas fa-play"></i></button>
                    <button class="skip-forward"><i class="fas fa-forward"></i></button>
                </li>
                <li class="options right">
                    <div class="playback-content">
                        <button class="playback-speed"><span class="material-symbols-rounded">slow_motion_video</span></button>
                        <ul class="speed-options">
                            <li data-speed="2">2x</li>
                            <li data-speed="1.5">1.5x</li>
                            <li data-speed="1" class="active">Normal</li>
                            <li data-speed="0.75">0.75x</li>
                            <li data-speed="0.5">0.5x</li>
                        </ul>
                    </div>
                    <button class="pic-in-pic"><span class="material-icons">picture_in_picture_alt</span></button>
                    <button class="fullscreen"><i class="fa-solid fa-expand"></i></button>
                </li>
            </ul>
        </div>
        <video class="film-play" id="main-video" src="{% if current_episode %}{{ current_episode.video.url }}{% else %}{{ movie.movie_file.url }}{% endif %}" controls></video>
        {% if movie.is_series %}
            <div class="series-info">
                {% if current_season %}
                    <span>Сезон: {{ current_season.season_number }}</span>
                {% else %}
                    <span>Сезон не выбран</span>
                {% endif %}
                {% if current_episode %}
                    <span>Серия: {{ current_episode.episode_number }}</span>
                {% else %}
                    <span>Серия не выбрана</span>
                {% endif %}
            </div>
            <div class="series-selector-container">
                <div class="series-selector">
                    <select id="season-select">
                        {% for season in movie.seasons.all %}
                            <option value="{{ season.season_number }}" {% if season == current_season %}selected{% endif %}>
                                Сезон {{ season.season_number }}
                            </option>
                        {% endfor %}
                    </select>
                    <select id="episode-select">
                        {% if current_season %}
                            {% for episode in current_season.episodes.all %}
                                <option value="{{ episode.episode_number }}" {% if episode == current_episode %}selected{% endif %}>
                                    Серия {{ episode.episode_number }}
                                </option>
                            {% endfor %}
                        {% else %}
                            <option value="">Сначала выберите сезон</option>
                        {% endif %}
                    </select>
                </div>
            </div>
        {% endif %}
    </div>
</div>


        <div class="block-two">
            <div class="block-info-film">
                <div class="icons-info">
                    <img src="{% static 'icons/comment.png' %}" alt="">
                    {% for genre in movie.genre.all|slice:"2:3" %}
                        <p>{{ genre.name }}</p>
                    {% endfor %}
                </div>

                <div class="icons-info">
                    <img src="{% static 'icons/star-vector.png' %}" alt="">
                    {% for genre in movie.genre.all|slice:":1" %}
                        <p>{{ genre.name }}</p>
                    {% endfor %}
                </div>

                <div class="icons-info">
                    <img src="{% static 'icons/light-vector.png' %}" alt="">
                    {% for genre in movie.genre.all|slice:"1:2" %}
                        <p>{{ genre.name }}</p>
                    {% endfor %}
                </div>
                <div class="icons-info-s">
                    <img src="{% static 'icons/time.png' %}" alt="">
                    {% if movie.is_series %}
                        <p>
                            Сезонов: {{ series_info.seasons_count }}
                            <br>
                            Эпизодов: {{ series_info.total_episodes }}
                            <br>
                            Длительность серии: {{ series_info.episode_duration }} минут
                        </p>
                    {% else %}
                        <p>
                            {{ movie.duration_hours }} часа
                            <br>
                            {{ movie.duration_minutes }} мин
                        </p>
                    {% endif %}
                </div>

            <div class="movie-interactions">
                <a href="{% url 'toggle_interaction' movie.id 'favorite' %}" class="interaction-icon" id="favorite-icon" data-is-favorite="{{ interaction.is_favorite|yesno:'true,false' }}">
                    <img src="{% static 'icons/favorite.png' %}" alt="Добавить в избранное">
                    <div class="icon-label">
                        {% if interaction and interaction.is_favorite %}
                            Убрать из избранного
                        {% else %}
                            Добавить в избранное
                        {% endif %}
                    </div>
                </a>
                <a href="{% url 'toggle_interaction' movie.id 'watched' %}" class="interaction-icon" id="watched-icon" data-is-watched="{{ interaction.is_watched|yesno:'true,false' }}">
                    <img src="{% static 'icons/watched.png' %}" alt="Отметить как просмотренное">
                    <div class="icon-label">
                        {% if interaction and interaction.is_watched %}
                            Убрать из просмотренных
                        {% else %}
                            Отметить как просмотренное
                        {% endif %}
                    </div>
                </a>
                <a href="{% url 'toggle_interaction' movie.id 'planned' %}" class="interaction-icon" id="planned-icon" data-is-planned="{{ interaction.is_planned|yesno:'true,false' }}">
                    <img src="{% static 'icons/planned.png' %}" alt="Добавить в планы">
                    <div class="icon-label">
                        {% if interaction and interaction.is_planned %}
                            Убрать из планов
                        {% else %}
                            Добавить в планы
                        {% endif %}
                    </div>
                </a>
            </div>



            </div>

            <div class="raiting">
                <div class="raiting-title">
                    Рейтинг {{ movie.title }}
                </div>

                <div class="raiting-star">
                    <form action="{% url 'add_rating' %}" method="post" name="rating">
                        <b>Рейтинг:</b>
                        {% csrf_token %}
                        <input type="hidden" value="{{ movie.id }}" name="movie">
                        <span class="rating">
                            {% for k, v in star_form.fields.star.choices %}
                                <input id="rating{{ v }}" type="radio" name="star" value="{{ k }}" {% if user_rating == k %}checked{% endif %}>
                                <label for="rating{{ v }}">{{ k }}</label>
                            {% endfor %}
                        </span>
                        <span class="editContent">{{ average_rating }}</span>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="reviews">
        <div class="review-one">
        {% if user.is_authenticated %}

            <form method="post" action="{% url 'add_review' pk=movie.pk %}">
                {% csrf_token %}
                <input type="email" id="email" name="email" placeholder="Email" required value="{{ user.email }}"   readonly >
                <br>
                <textarea id="feedback" name="text" rows="4" cols="50" placeholder="Напишите ваш отзыв..." required></textarea>
                <input type="hidden" name="parent_id" id="parent_id" value="">
                <br>
                <button class="pa" type="submit">Отправить</button>
            </form>
        {% else %}
            <div class="center">
                <a class="link" href="">Войдите</a> чтобы оставить отзыв
            </div>
        {% endif %}
        </div>

<div class="review-two">
    {% for review in reviews %}
        <div class="review-people">
            {% if review.user.profile.photo %}
                <div class="img-people-dj">
                    <img src="{{ review.user.profile.photo.url }}" alt="Profile Photo">
                </div>
            {% else %}
                <div class="img-people"></div>
            {% endif %}
            <div class="email-text">
                <div class="email">{{ review.user.email }}</div>
                <div class="review-text">{{ review.text }}</div>
                <a href="#" class="reply-link" data-email="{{ review.user.email }}" data-id="{{ review.id }}">Ответить</a>
            </div>
            {% if review.replies.all %}
                <div class="show-replies" onclick="toggleReplies(this)">Показать ответы</div>
            {% endif %}
        </div>
        <div class="replies-container" style="display: none;">
            {% for reply in review.replies.all %}
                <div class="reply review-people">
                    {% if reply.user.profile.photo %}
                        <div class="img-people-dj">
                            <img src="{{ reply.user.profile.photo.url }}" alt="Profile Photo">
                        </div>
                    {% else %}
                        <div class="img-people"><img src="{% static 'images/profile.png' %}"></div>
                    {% endif %}
                    <div class="email-text">
                        <div class="email">{{ reply.user.email }}</div>
                        <div class="review-text">{{ reply.text }}</div>
                        <a href="#" class="reply-link" data-email="{{ reply.user.email }}" data-id="{{ reply.id }}">Ответить</a>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% empty %}
        <div class="review-people">
            <p>Пока нет отзывов.</p>
        </div>
    {% endfor %}
</div>






    </div>
</div>



{% endblock %}

{% block js %}
    <script src="{% static 'javascript/product.js' %}"></script>
    <script src="{% static 'javascript/pl.js' %}"></script>
    <script src="{% static 'javascript/pl-tr.js' %}"></script>
    <script src="{% static 'javascript/index.js' %}"></script>

    <script>
        function bindReplyLinks() {
            document.querySelectorAll('.reply-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const email = this.getAttribute('data-email');
                    const parentId = this.getAttribute('data-id');
                    const textarea = document.querySelector('#feedback');
                    const parentInput = document.createElement('input');
                    parentInput.type = 'hidden';
                    parentInput.name = 'parent_id';
                    parentInput.value = parentId;
                    textarea.value = `${email}, `;
                    textarea.focus();
                    if (!document.querySelector('input[name="parent_id"]')) {
                        document.querySelector('form').appendChild(parentInput);
                    } else {
                        document.querySelector('input[name="parent_id"]').value = parentId;
                    }
                });
            });
        }

        function toggleReplies(button) {
            var repliesContainer = button.parentNode.nextElementSibling;
            if (repliesContainer.classList.contains('show')) {
                repliesContainer.classList.remove('show');
                repliesContainer.classList.add('hide');
                setTimeout(function() {
                    repliesContainer.style.display = 'none';
                    repliesContainer.classList.remove('hide');
                }, 500);
                button.innerText = "Показать ответы";
            } else {
                repliesContainer.style.display = 'block';
                repliesContainer.classList.add('show');
                button.innerText = "Скрыть ответы";

                const email = button.getAttribute('data-email');
                const id = button.getAttribute('data-id');

                const textarea = document.querySelector('#feedback');
                const currentText = textarea.value;
                const newText = currentText ? `${currentText}, ${email}` : email;
                textarea.value = newText;
                textarea.focus();

                document.querySelector('#parent_id').value = id;
            }
        }
        window.onload = function() {
            bindReplyLinks();
        };

    document.querySelectorAll('.popup-movie .close').forEach(closeBtn => {
        closeBtn.addEventListener('click', () => {
            closeBtn.closest('.popup-movie').style.display = 'none';

            // Pause the main video and reset the play/pause button
            const mainVideo = closeBtn.closest('.popup-movie').querySelector('video');
            if (mainVideo) {
                mainVideo.pause();
            }
            const playPauseBtn = closeBtn.closest('.popup-movie').querySelector('.play-pause i');
            if (playPauseBtn) {
                playPauseBtn.classList.replace("fa-pause", "fa-play");
            }
        });
    });


    </script>

    <script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.interaction-icon').forEach(function(element) {
        const iconElement = element.querySelector('img');
        const labelElement = element.querySelector('.icon-label');

        // Set initial state based on data attributes
        updateIconAndLabel(element);

        element.addEventListener('click', function(event) {
            event.preventDefault();
            const url = this.href;

            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_favorite !== undefined) {
                    element.setAttribute('data-is-favorite', data.is_favorite);
                } else if (data.is_watched !== undefined) {
                    element.setAttribute('data-is-watched', data.is_watched);
                } else if (data.is_planned !== undefined) {
                    element.setAttribute('data-is-planned', data.is_planned);
                }
                updateIconAndLabel(element);
            })
            .catch(error => console.error('Error:', error));
        });
    });
});

function updateIconAndLabel(element) {
    const isFavorite = element.getAttribute('data-is-favorite') === 'true';
    const isWatched = element.getAttribute('data-is-watched') === 'true';
    const isPlanned = element.getAttribute('data-is-planned') === 'true';
    const iconElement = element.querySelector('img');
    const labelElement = element.querySelector('.icon-label');

    if (element.id === 'favorite-icon') {
        if (isFavorite) {
            iconElement.src = '/static/icons/favorite_active.png';
            labelElement.textContent = 'Убрать из избранного';
        } else {
            iconElement.src = '/static/icons/favorite.png';
            labelElement.textContent = 'Добавить в избранное';
        }
    } else if (element.id === 'watched-icon') {
        if (isWatched) {
            iconElement.src = '/static/icons/watched_active.png';
            labelElement.textContent = 'Убрать из просмотренных';
        } else {
            iconElement.src = '/static/icons/watched.png';
            labelElement.textContent = 'Отметить как просмотренное';
        }
    } else if (element.id === 'planned-icon') {
        if (isPlanned) {
            iconElement.src = '/static/icons/planned_active.png';
            labelElement.textContent = 'Убрать из планов';
        } else {
            iconElement.src = '/static/icons/planned.png';
            labelElement.textContent = 'Добавить в планы';
        }
    }
}

    </script>
{% endblock %}


